@page "/flujoCliente"
@rendermode InteractiveServer
@using BlazorApp.Models.DTs
@using BlazorApp.Models.Interfaces
@using Microsoft.AspNetCore.SignalR.Client
@inject IOficinaRepository OficinaRepository
@inject NavigationManager NavigationManager

<h3>Flujo de Clientes en Espera</h3>

@if (oficinas == null)
{
    <p>Cargando oficinas...</p>
}
else
{
    <RadzenDataGrid Data="@oficinas"  @key="oficinas?.Count">
        <Columns>
            <!-- Columna para el nombre de la oficina -->
            <RadzenDataGridColumn  />

            <!-- Columna con el gráfico de clientes y el nombre de la oficina dentro del gráfico -->
            <RadzenDataGridColumn >
                <Template Context="data">
                    @{
                        var clienteCount = data.ClientesIds.Count();
                        var rectColor = clienteCount < 5 ? "green" : clienteCount < 10 ? "yellow" : "red";
                        var rectWidth = Math.Max(clienteCount * 20, 0);
                    }
                    <svg width="100%" height="40">
                        <!-- Nombre de la oficina dentro del gráfico -->
                        <text x="5" y="15" fill="black" font-weight="bold">@data.Nombre</text>
                        <!-- Rectángulo representando la cantidad de clientes -->
                        <rect y="20" width="@rectWidth" height="20" fill="@rectColor" />
                        <!-- Texto con el número de clientes junto al gráfico -->
                        <text x="@(rectWidth + 10)" y="35" fill="black">@clienteCount</text>
                    </svg>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}

@code {
    private List<DTOficina> oficinas = new List<DTOficina>();
    private HubConnection hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadOficinasAsync();  // Carga inicial
        await SetupSignalRAsync();  // Configura SignalR para actualizaciones en tiempo real
    }

    private async Task LoadOficinasAsync()
    {
        try
        {
            oficinas = OficinaRepository.ListarClientesOficinasDTO();
            await InvokeAsync(StateHasChanged); // Actualiza la UI
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error fetching oficinas: {ex.Message}");
            oficinas = new List<DTOficina>();
            await InvokeAsync(StateHasChanged); // Asegura que la UI refleje el estado
        }
    }

    private async Task SetupSignalRAsync()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/oficinasHub"))
            .Build();

        // Configura SignalR para recargar las oficinas cuando haya cambios
        hubConnection.On("ReceiveOficinas", async () =>
        {
            await LoadOficinasAsync();  // Recarga la lista de oficinas
        });

        await hubConnection.StartAsync();
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();  // Asegura que se cierre la conexión de SignalR
        }
    }
}
